<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M4A → MP3 Converter (iPad安定版)</title>
  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      padding: 16px;
      line-height: 1.6;
    }
    button {
      padding: 10px 14px;
      margin-top: 8px;
      font-size: 16px;
    }
    #log {
      white-space: pre-wrap;
      background: #f5f5f7;
      padding: 10px;
      border-radius: 8px;
      margin-top: 12px;
    }
    #filename {
      display: block;
      margin-top: 8px;
      color: #333;
      font-size: 14px;
    }
    #download {
      display: none;
      margin-top: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>M4A → MP3（iPad安定版・端末内変換）</h2>

  <!-- iPad対策：inputは隠す -->
  <input id="file" type="file" style="display:none" />

  <button id="pick">ファイルを選択</button>
  <span id="filename">未選択</span>

  <div style="margin-top:12px;">
    <label>ビットレート：</label>
    <select id="bitrate">
      <option value="128k">128k（軽い）</option>
      <option value="192k" selected>192k（おすすめ）</option>
      <option value="320k">320k（重い）</option>
    </select>
    <br/>
    <button id="convert">変換</button>
  </div>

  <div id="log">準備中…</div>
  <a id="download">MP3をダウンロード</a>

  <script type="module">
    import { FFmpeg } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js";
    import { fetchFile } from "https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js";

    const logEl = document.getElementById("log");
    const fileEl = document.getElementById("file");
    const pickBtn = document.getElementById("pick");
    const nameEl = document.getElementById("filename");
    const bitrateEl = document.getElementById("bitrate");
    const dlEl = document.getElementById("download");
    const btn = document.getElementById("convert");

    const ffmpeg = new FFmpeg();

    function log(msg) {
      logEl.textContent = msg;
    }

    // iPad安定化：ボタン経由でファイルピッカー
    pickBtn.onclick = () => {
      fileEl.click();
    };

    // ファイル選択検知
    fileEl.addEventListener("change", () => {
      const f = fileEl.files?.[0];
      if (f) {
        nameEl.textContent = `選択済み: ${f.name}`;
        log(`選択済み: ${f.name}`);
      } else {
        nameEl.textContent = "未選択";
        log("ファイル未選択");
      }
    });

    // ffmpegログ（軽量表示）
    ffmpeg.on("log", ({ message }) => {
      const lines = (logEl.textContent + "\n" + message).split("\n");
      logEl.textContent = lines.slice(-12).join("\n");
    });

    btn.onclick = async () => {
      const f = fileEl.files?.[0];
      if (!f) {
        log("⚠️ 先にファイルを選択してください");
        return;
      }

      dlEl.style.display = "none";
      log("ffmpeg読み込み中…（初回は時間がかかります）");

      if (!ffmpeg.loaded) {
        await ffmpeg.load({
          coreURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js",
          wasmURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.wasm",
        });
      }

      const inName = "input.m4a";
      const outName = "output.mp3";

      log("入力を準備中…");
      await ffmpeg.writeFile(inName, await fetchFile(f));

      const br = bitrateEl.value;
      log("変換中…（画面を閉じないでください）");

      await ffmpeg.exec([
        "-i", inName,
        "-vn",
        "-b:a", br,
        "-ar", "44100",
        outName
      ]);

      log("書き出し中…");
      const data = await ffmpeg.readFile(outName);
      const blob = new Blob([data.buffer], { type: "audio/mpeg" });
      const url = URL.createObjectURL(blob);

      dlEl.href = url;
      dlEl.download = f.name.replace(/\.[^.]+$/, "") + ".mp3";
      dlEl.style.display = "inline-block";

      log("✅ 完了！ダウンロードできます。");
    };

    log("ファイルを選択してください。");
  </script>
</body>
</html>