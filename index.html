<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!--
    ============================================================
    M4A â†’ MP3 å¤‰æ›ã‚¢ãƒ—ãƒªï¼ˆiPad Safari å®Œå…¨å¯¾å¿œç‰ˆï¼‰
    ============================================================
    ç‰¹å¾´:
    - iPad Safari ã§ã®å®‰å®šå‹•ä½œã‚’æœ€å„ªå…ˆ
    - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å®Œçµï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
    - GitHub Pages ã§å‹•ä½œ
    - åˆå­¦è€…ã«ã‚‚ç†è§£ã—ã‚„ã™ã„æ§‹é€ 
    
    æŠ€è¡“çš„å¯¾ç­–:
    1. SharedArrayBuffer éä¾å­˜ã® ffmpeg.wasm ã‚’ä½¿ç”¨
    2. ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ä¿¡é ¼æ€§ç¢ºä¿ï¼ˆtouchend + clickï¼‰
    3. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®å®‰å®šåŒ–ï¼ˆéš ã—input + ãƒœã‚¿ãƒ³é€£æºï¼‰
    4. ãƒ¡ãƒ¢ãƒªåˆ¶ç´„å¯¾å¿œï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼‰
    5. åˆå›ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    
    å‹•ä½œç¢ºèªæ¸ˆã¿: iPad Safari 17+, iOS 17+
    ============================================================
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>M4A â†’ MP3 å¤‰æ›</title>
  
  <style>
    /* ============================================================
       CSS ãƒªã‚»ãƒƒãƒˆã¨åŸºæœ¬è¨­å®š
       ============================================================ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      /* iOS Safari ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®‰å®šåŒ– */
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 
                   'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      min-height: 100dvh; /* iOS Safari å¯¾å¿œ */
      padding: 16px;
      padding-bottom: env(safe-area-inset-bottom, 16px);
    }
    
    /* ============================================================
       åˆå›ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
       ============================================================ */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    
    #loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: white;
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
    }
    
    .loading-subtext {
      color: rgba(255, 255, 255, 0.8);
      margin-top: 8px;
      font-size: 13px;
    }
    
    /* ============================================================
       ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
       ============================================================ */
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    /* ============================================================
       ãƒ˜ãƒƒãƒ€ãƒ¼
       ============================================================ */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 24px 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    
    .header p {
      font-size: 13px;
      opacity: 0.8;
    }
    
    /* ============================================================
       ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
       ============================================================ */
    .content {
      padding: 24px 20px;
    }
    
    /* ============================================================
       ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
       ============================================================ */
    .status-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .status-card.selected {
      background: #e8f5e9;
      border-color: #4caf50;
    }
    
    .status-card.converting {
      background: #fff3e0;
      border-color: #ff9800;
    }
    
    .status-card.completed {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .status-card.error {
      background: #ffebee;
      border-color: #f44336;
    }
    
    .status-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .status-text {
      font-size: 15px;
      color: #333;
      word-break: break-all;
    }
    
    .status-icon {
      font-size: 20px;
      margin-right: 8px;
    }
    
    /* ============================================================
       ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ï¼ˆiPad å®‰å®šåŒ–è¨­è¨ˆï¼‰
       iPad Safari ã§ã¯éš ã—inputã‚’ãƒœã‚¿ãƒ³çµŒç”±ã§ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
       ============================================================ */
    .file-input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    
    /* éš ã—input - å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’æ‹…å½“ */
    .file-input-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* ã‚¿ãƒƒãƒ—é ˜åŸŸã‚’å¤§ããã—ãŸãƒœã‚¿ãƒ³ */
    .file-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 64px;
      padding: 16px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      /* ã‚¿ãƒƒãƒæ“ä½œã®å®‰å®šåŒ– */
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .file-select-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    
    .file-select-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .file-select-btn .icon {
      font-size: 24px;
      margin-right: 10px;
    }
    
    /* ============================================================
       è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
       ============================================================ */
    .settings-section {
      margin-bottom: 20px;
    }
    
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .setting-row:last-child {
      border-bottom: none;
    }
    
    .setting-label {
      font-size: 15px;
      color: #333;
    }
    
    .setting-select {
      padding: 10px 16px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      color: #333;
      min-width: 140px;
      /* iOS Safari å¯¾å¿œ */
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    /* ============================================================
       å¤‰æ›ãƒœã‚¿ãƒ³
       ============================================================ */
    .convert-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 60px;
      padding: 16px 24px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      margin-bottom: 16px;
    }
    
    .convert-btn:active {
      transform: scale(0.98);
    }
    
    .convert-btn:disabled {
      background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
      cursor: not-allowed;
    }
    
    .convert-btn .icon {
      font-size: 22px;
      margin-right: 10px;
    }
    
    /* ============================================================
       ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
       ============================================================ */
    .progress-container {
      margin-bottom: 20px;
      display: none;
    }
    
    .progress-container.visible {
      display: block;
    }
    
    .progress-bar-wrapper {
      background: #e0e0e0;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
      background-size: 200% 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .progress-text {
      font-size: 13px;
      color: #666;
      text-align: center;
    }
    
    /* ============================================================
       ãƒ­ã‚°è¡¨ç¤º
       ============================================================ */
    .log-section {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      max-height: 150px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .log-content {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      color: #00ff88;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.5;
    }
    
    /* ============================================================
       ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
       ============================================================ */
    .download-section {
      display: none;
    }
    
    .download-section.visible {
      display: block;
    }
    
    .download-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 60px;
      padding: 16px 24px;
      background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .download-btn:active {
      transform: scale(0.98);
    }
    
    .download-btn .icon {
      font-size: 22px;
      margin-right: 10px;
    }
    
    /* ============================================================
       ãƒ•ãƒƒã‚¿ãƒ¼
       ============================================================ */
    .footer {
      text-align: center;
      padding: 16px 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .footer p {
      font-size: 12px;
      color: #999;
    }
    
    /* ============================================================
       ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
       ============================================================ */
    .error-message {
      background: #ffebee;
      border: 1px solid #f44336;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: none;
    }
    
    .error-message.visible {
      display: block;
    }
    
    .error-message p {
      color: #c62828;
      font-size: 14px;
      margin: 0;
    }
    
    /* ============================================================
       æ³¨æ„äº‹é …
       ============================================================ */
    .notice {
      background: #fff8e1;
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 16px;
    }
    
    .notice p {
      font-size: 12px;
      color: #f57c00;
      margin: 0;
    }
    
    .notice p + p {
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- ============================================================
       åˆå›ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
       ffmpeg.wasm ã®èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§è¡¨ç¤º
       ============================================================ -->
  <div id="loading-screen">
    <div class="loading-spinner"></div>
    <p class="loading-text">ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
    <p class="loading-subtext">åˆå›ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</p>
  </div>

  <!-- ============================================================
       ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
       ============================================================ -->
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>ğŸµ M4A â†’ MP3 å¤‰æ›</h1>
      <p>ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµãƒ»ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãªã—</p>
    </div>
    
    <div class="content">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div id="status-card" class="status-card">
        <div class="status-label">ç¾åœ¨ã®çŠ¶æ…‹</div>
        <div class="status-text">
          <span class="status-icon">ğŸ“</span>
          <span id="status-message">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
        </div>
      </div>
      
      <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="error-message" class="error-message">
        <p id="error-text"></p>
      </div>
      
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆiPad å®‰å®šåŒ–è¨­è¨ˆï¼‰-->
      <div class="file-input-wrapper">
        <!--
          iPad Safari å®‰å®šåŒ–ã®ãƒã‚¤ãƒ³ãƒˆ:
          1. input[type=file] ã¯éè¡¨ç¤ºã«ã™ã‚‹
          2. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ input.click() ã‚’å‘¼ã¶
          3. accept å±æ€§ã§ .m4a, audio/* ã‚’æŒ‡å®š
        -->
        <input 
          type="file" 
          id="file-input" 
          class="file-input-hidden"
          accept=".m4a,.mp4a,audio/mp4,audio/x-m4a,audio/*"
        >
        <button type="button" id="file-select-btn" class="file-select-btn">
          <span class="icon">ğŸ“‚</span>
          <span>M4Aãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
        </button>
      </div>
      
      <!-- è¨­å®š -->
      <div class="settings-section">
        <div class="setting-row">
          <span class="setting-label">éŸ³è³ªï¼ˆãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆï¼‰</span>
          <select id="bitrate-select" class="setting-select">
            <option value="128">128kbpsï¼ˆè»½é‡ï¼‰</option>
            <option value="192" selected>192kbpsï¼ˆæ¨å¥¨ï¼‰</option>
            <option value="256">256kbpsï¼ˆé«˜éŸ³è³ªï¼‰</option>
            <option value="320">320kbpsï¼ˆæœ€é«˜ï¼‰</option>
          </select>
        </div>
      </div>
      
      <!-- å¤‰æ›ãƒœã‚¿ãƒ³ -->
      <button type="button" id="convert-btn" class="convert-btn" disabled>
        <span class="icon">ğŸ”„</span>
        <span>MP3ã«å¤‰æ›</span>
      </button>
      
      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
      <div id="progress-container" class="progress-container">
        <div class="progress-bar-wrapper">
          <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="progress-text">æº–å‚™ä¸­...</p>
      </div>
      
      <!-- ãƒ­ã‚°è¡¨ç¤º -->
      <div class="log-section">
        <pre id="log-content" class="log-content">æº–å‚™å®Œäº†ã‚’å¾…ã£ã¦ã„ã¾ã™...</pre>
      </div>
      
      <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <div id="download-section" class="download-section">
        <a id="download-btn" class="download-btn" download>
          <span class="icon">ğŸ’¾</span>
          <span>MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
        </a>
      </div>
      
      <!-- æ³¨æ„äº‹é … -->
      <div class="notice">
        <p>ğŸ’¡ å¤‰æ›ä¸­ã¯ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„</p>
        <p>ğŸ’¡ å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ50MBä»¥ä¸Šï¼‰ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</p>
        <p>ğŸ’¡ ã™ã¹ã¦ã®å‡¦ç†ã¯ãŠä½¿ã„ã®ç«¯æœ«å†…ã§è¡Œã‚ã‚Œã¾ã™</p>
      </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="footer">
      <p>Â© 2025 M4A to MP3 Converter</p>
      <p>Powered by ffmpeg.wasm</p>
    </div>
  </div>

  <!-- ============================================================
       JavaScriptï¼ˆES Moduleï¼‰
       
       iPad Safari å¯¾å¿œã®ãƒã‚¤ãƒ³ãƒˆ:
       1. SharedArrayBuffer ã‚’ä½¿ã‚ãªã„ ffmpeg.wasm ã‚’ä½¿ç”¨
       2. ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ä¿¡é ¼æ€§ç¢ºä¿
       3. é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
       4. ãƒ¡ãƒ¢ãƒªç®¡ç†
       ============================================================ -->
  <script type="module">
    // ============================================================
    // ffmpeg.wasm ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    // jsDelivr CDN ã‚’ä½¿ç”¨ï¼ˆCORS å¯¾å¿œãƒ»é«˜é€Ÿãƒ»å®‰å®šï¼‰
    // toBlobURL ã‚’ä½¿ç”¨ã—ã¦ Worker CORS å•é¡Œã‚’å›é¿
    // ============================================================
    import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js';
    import { fetchFile, toBlobURL } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js';
    
    // ============================================================
    // DOM è¦ç´ ã®å–å¾—
    // ============================================================
    const loadingScreen = document.getElementById('loading-screen');
    const statusCard = document.getElementById('status-card');
    const statusMessage = document.getElementById('status-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const fileInput = document.getElementById('file-input');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const bitrateSelect = document.getElementById('bitrate-select');
    const convertBtn = document.getElementById('convert-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const logContent = document.getElementById('log-content');
    const downloadSection = document.getElementById('download-section');
    const downloadBtn = document.getElementById('download-btn');
    
    // ============================================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
    // ============================================================
    let selectedFile = null;
    let isConverting = false;
    let ffmpegLoaded = false;
    
    // ffmpeg ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    const ffmpeg = new FFmpeg();
    
    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ============================================================
    
    /**
     * ãƒ­ã‚°ã‚’è¿½åŠ ï¼ˆæœ€æ–°10è¡Œã®ã¿è¡¨ç¤ºï¼‰
     */
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const lines = logContent.textContent.split('\n');
      lines.push(`[${timestamp}] ${message}`);
      // æœ€æ–°10è¡Œã®ã¿ä¿æŒ
      logContent.textContent = lines.slice(-10).join('\n');
      // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    }
    
    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
     */
    function updateStatus(message, type = 'default') {
      statusMessage.textContent = message;
      
      // ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
      statusCard.className = 'status-card';
      if (type !== 'default') {
        statusCard.classList.add(type);
      }
      
      // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
      const iconElement = statusCard.querySelector('.status-icon');
      const icons = {
        default: 'ğŸ“',
        selected: 'âœ…',
        converting: 'â³',
        completed: 'ğŸ‰',
        error: 'âŒ'
      };
      iconElement.textContent = icons[type] || icons.default;
    }
    
    /**
     * ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
     */
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.add('visible');
      updateStatus(message, 'error');
      addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${message}`);
    }
    
    /**
     * ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤º
     */
    function hideError() {
      errorMessage.classList.remove('visible');
    }
    
    /**
     * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚’æ›´æ–°
     */
    function updateProgress(percent, message) {
      progressBar.style.width = `${percent}%`;
      progressText.textContent = message;
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
     */
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‚’ãƒã‚§ãƒƒã‚¯
     */
    function isValidAudioFile(file) {
      const validExtensions = ['.m4a', '.mp4a', '.mp4'];
      const validMimeTypes = ['audio/mp4', 'audio/x-m4a', 'audio/m4a', 'audio/aac'];
      
      const extension = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
      const mimeType = file.type.toLowerCase();
      
      return validExtensions.includes(extension) || 
             validMimeTypes.includes(mimeType) ||
             mimeType.startsWith('audio/');
    }
    
    // ============================================================
    // ffmpeg.wasm ã®åˆæœŸåŒ–
    // ============================================================
    async function initFFmpeg() {
      addLog('ffmpeg.wasm ã‚’åˆæœŸåŒ–ä¸­...');
      
      try {
        // ãƒ­ã‚°ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
        ffmpeg.on('log', ({ message }) => {
          // å¤‰æ›é€²æ—ã®è§£æ
          if (message.includes('time=')) {
            const timeMatch = message.match(/time=(\d{2}):(\d{2}):(\d{2})/);
            if (timeMatch) {
              const seconds = parseInt(timeMatch[1]) * 3600 + 
                            parseInt(timeMatch[2]) * 60 + 
                            parseInt(timeMatch[3]);
              addLog(`å‡¦ç†æ™‚é–“: ${seconds}ç§’`);
            }
          }
        });
        
        // é€²æ—ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
        ffmpeg.on('progress', ({ progress }) => {
          const percent = Math.round(progress * 100);
          updateProgress(percent, `å¤‰æ›ä¸­... ${percent}%`);
        });
        
        // ffmpeg.wasm ã®ãƒ­ãƒ¼ãƒ‰
        // æ³¨æ„: SharedArrayBuffer ã‚’ä½¿ã‚ãªã„ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆã‚’ä½¿ç”¨
        // toBlobURL ã‚’ä½¿ç”¨ã—ã¦ Worker CORS å•é¡Œã‚’å›é¿ï¼ˆiPad Safari å¯¾å¿œï¼‰
        const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm';
        const ffmpegBaseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/esm';
        
        await ffmpeg.load({
          coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
          wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
          classWorkerURL: await toBlobURL(`${ffmpegBaseURL}/worker.js`, 'text/javascript'),
        });
        
        ffmpegLoaded = true;
        addLog('âœ… ffmpeg.wasm ã®æº–å‚™å®Œäº†');
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
        loadingScreen.classList.add('hidden');
        
        return true;
      } catch (error) {
        console.error('ffmpeg init error:', error);
        addLog(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        const loadingText = loadingScreen.querySelector('.loading-text');
        loadingText.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
        loadingText.style.color = '#ff6b6b';
        
        return false;
      }
    }
    
    // ============================================================
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©
    // iPad Safari å®‰å®šåŒ–: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ input.click() ã‚’å‘¼ã¶
    // ============================================================
    function handleFileSelectClick(event) {
      // å¤‰æ›ä¸­ã¯é¸æŠä¸å¯
      if (isConverting) {
        event.preventDefault();
        return;
      }
      
      // iPad Safari å¯¾ç­–: å°‘ã—é…å»¶ã‚’å…¥ã‚Œã‚‹
      setTimeout(() => {
        fileInput.click();
      }, 10);
    }
    
    // ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆclick + touchend ã§ç¢ºå®Ÿã«å‹•ä½œï¼‰
    fileSelectBtn.addEventListener('click', handleFileSelectClick);
    
    // iPad Safari ç”¨ã®è¿½åŠ å¯¾ç­–ï¼ˆã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼‰
    fileSelectBtn.addEventListener('touchend', (event) => {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢ã—ã¦ã‹ã‚‰ click ã‚’ãƒˆãƒªã‚¬ãƒ¼
      event.preventDefault();
      handleFileSelectClick(event);
    }, { passive: false });
    
    // ============================================================
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
    // ============================================================
    fileInput.addEventListener('change', (event) => {
      hideError();
      
      const file = event.target.files?.[0];
      
      if (!file) {
        selectedFile = null;
        updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'default');
        convertBtn.disabled = true;
        addLog('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        return;
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
      if (!isValidAudioFile(file)) {
        showError('M4A ã¾ãŸã¯éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        selectedFile = null;
        convertBtn.disabled = true;
        return;
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ100MBåˆ¶é™æ¨å¥¨ï¼‰
      const maxSize = 100 * 1024 * 1024; // 100MB
      if (file.size > maxSize) {
        showError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ${formatFileSize(file.size)}ï¼‰ã€‚100MBä»¥ä¸‹ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`);
        // è­¦å‘Šã®ã¿ã§ç¶šè¡Œå¯èƒ½
      }
      
      selectedFile = file;
      updateStatus(`${file.name} (${formatFileSize(file.size)})`, 'selected');
      convertBtn.disabled = false;
      addLog(`âœ… é¸æŠ: ${file.name} (${formatFileSize(file.size)})`);
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      downloadSection.classList.remove('visible');
    });
    
    // ============================================================
    // å¤‰æ›å‡¦ç†
    // ============================================================
    async function convertToMP3() {
      if (!selectedFile || isConverting) return;
      
      // ffmpeg ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆ
      if (!ffmpegLoaded) {
        addLog('ffmpeg.wasm ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const loaded = await initFFmpeg();
        if (!loaded) return;
      }
      
      isConverting = true;
      hideError();
      convertBtn.disabled = true;
      fileSelectBtn.disabled = true;
      
      updateStatus('å¤‰æ›ä¸­...', 'converting');
      progressContainer.classList.add('visible');
      updateProgress(0, 'æº–å‚™ä¸­...');
      downloadSection.classList.remove('visible');
      
      const inputFileName = 'input.m4a';
      const outputFileName = 'output.mp3';
      const bitrate = bitrateSelect.value;
      
      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        addLog('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        const fileData = await fetchFile(selectedFile);
        await ffmpeg.writeFile(inputFileName, fileData);
        
        addLog(`å¤‰æ›é–‹å§‹: ${bitrate}kbps`);
        updateProgress(20, 'å¤‰æ›ä¸­...');
        
        // å¤‰æ›å®Ÿè¡Œ
        // -vn: æ˜ åƒã‚’ç„¡åŠ¹åŒ–
        // -b:a: ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ
        // -ar: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¬ãƒ¼ãƒˆ 44100Hz
        // -ac: ãƒãƒ£ãƒ³ãƒãƒ«æ•°ï¼ˆã‚¹ãƒ†ãƒ¬ã‚ªï¼‰
        await ffmpeg.exec([
          '-i', inputFileName,
          '-vn',
          '-b:a', `${bitrate}k`,
          '-ar', '44100',
          '-ac', '2',
          '-f', 'mp3',
          outputFileName
        ]);
        
        // çµæœã®å–å¾—
        addLog('å¤‰æ›çµæœã‚’å–å¾—ä¸­...');
        updateProgress(90, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­...');
        
        const data = await ffmpeg.readFile(outputFileName);
        
        // Blob ã‚’ä½œæˆ
        const blob = new Blob([data.buffer], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¨­å®š
        const outputName = selectedFile.name.replace(/\.[^.]+$/, '') + '.mp3';
        downloadBtn.href = url;
        downloadBtn.download = outputName;
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        try {
          await ffmpeg.deleteFile(inputFileName);
          await ffmpeg.deleteFile(outputFileName);
        } catch (e) {
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
        
        // å®Œäº†
        updateProgress(100, 'å®Œäº†ï¼');
        updateStatus(`å¤‰æ›å®Œäº†: ${outputName}`, 'completed');
        downloadSection.classList.add('visible');
        addLog(`âœ… å¤‰æ›å®Œäº†: ${outputName}`);
        
      } catch (error) {
        console.error('Conversion error:', error);
        showError(`å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
        progressContainer.classList.remove('visible');
      } finally {
        isConverting = false;
        convertBtn.disabled = !selectedFile;
        fileSelectBtn.disabled = false;
      }
    }
    
    // å¤‰æ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    convertBtn.addEventListener('click', convertToMP3);
    
    // iPad Safari ç”¨ã®è¿½åŠ å¯¾ç­–
    convertBtn.addEventListener('touchend', (event) => {
      if (!convertBtn.disabled) {
        event.preventDefault();
        convertToMP3();
      }
    }, { passive: false });
    
    // ============================================================
    // åˆæœŸåŒ–
    // ============================================================
    (async () => {
      addLog('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ä¸­...');
      
      // ffmpeg.wasm ã®åˆæœŸåŒ–
      await initFFmpeg();
      
      updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'default');
    })();
    
    // ============================================================
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
    // ============================================================
    window.appDebug = {
      ffmpeg,
      get selectedFile() { return selectedFile; },
      get isConverting() { return isConverting; },
      get ffmpegLoaded() { return ffmpegLoaded; }
    };
  </script>
</body>
</html>
